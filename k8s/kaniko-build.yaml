---
# Run Kaniko using `kubectl create -f k8s/kaniko-build.yaml`.
# See README.md for more information.
apiVersion: batch/v1
kind: Job
metadata:
  name: build-image
  labels:
    kueue.x-k8s.io/queue-name: farai
spec:
  suspend: true
  backoffLimit: 0
  template:
    metadata:
      name: kaniko
    spec:
      priorityClassName: cpu-normal-batch
      containers:
        - name: kaniko
          # executor:debug image is needed to run `$(date ...)` in a subshell.
          # executor:latest does not have a shell to save space.
          image: gcr.io/kaniko-project/executor:debug
          command: ["/busybox/sh", "-c"]
          args: ["/kaniko/executor --dockerfile=Dockerfile --verbosity=debug \
                 --context=git://github.com/AlignmentResearch/robust-llm.git#refs/heads/$(BRANCH_NAME) \
                 --git=recurse-submodules=true --cache=true --cache-repo=ghcr.io/alignmentresearch/robust-llm/cache \
                 --destination=ghcr.io/alignmentresearch/robust-llm:$(date +'%Y-%m-%d-%H-%M-%S')-$(BRANCH_NAME)"]
          volumeMounts:
            - name: docker
              mountPath: /kaniko/.docker
          env:
            - name: GIT_ASKPASS
              value: "false"
            - name: GIT_USERNAME
              valueFrom:
                secretKeyRef:
                  name: github-credentials
                  key: pat
            - name: BRANCH_NAME
              value: "main"
          resources:
            requests:
              cpu: 1
            limits:
              memory: "45G"
      restartPolicy: Never
      imagePullSecrets:
        - name: docker
      volumes:
        - name: docker
          secret:
            secretName: docker
            items:
              - key: .dockerconfigjson
                path: config.json
        - name: github-credentials
          secret:
            secretName: github-credentials
